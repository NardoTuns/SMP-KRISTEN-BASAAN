<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulir Pendaftaran - SMP Kristen Basaan</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
      background: #f8f9fa;
      line-height: 1.6;
    }
    h2 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 20px;
    }
    .form-container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 500;
      color: #34495e;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      margin-top: 5px;
      box-sizing: border-box;
      font-size: 15px;
    }
    input:focus, select:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    button {
      margin-top: 25px;
      width: 100%;
      padding: 12px;
      background-color: #2ecc71;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #27ae60;
    }
    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    .progress-container {
      margin-top: 20px;
      display: none;
    }
    .progress {
      width: 100%;
      background: #ecf0f1;
      border-radius: 5px;
      overflow: hidden;
      height: 8px;
    }
    .progress-bar {
      width: 0;
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2ecc71);
      transition: width 0.3s;
    }
    .notif {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
      font-weight: 500;
    }
    .success {
      background-color: #d5f5e3;
      color: #27ae60;
      border: 1px solid #2ecc71;
    }
    .error {
      background-color: #fadbd8;
      color: #e74c3c;
      border: 1px solid #e74c3c;
    }
    .file-info {
      font-size: 13px;
      color: #7f8c8d;
      margin-top: 3px;
    }
    .required:after {
      content: " *";
      color: #e74c3c;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Formulir Pendaftaran SMP Kristen Basaan</h2>
    <form id="formulir">
      <label class="required">Nama Lengkap:</label>
      <input type="text" name="nama" required placeholder="Nama sesuai akta">
      
      <label class="required">Jenis Kelamin:</label>
      <select name="jk" required>
        <option value="">-- Pilih Jenis Kelamin --</option>
        <option value="Laki-laki">Laki-laki</option>
        <option value="Perempuan">Perempuan</option>
      </select>

      <label class="required">NISN:</label>
      <input type="text" name="nisn" required placeholder="Nomor Induk Siswa Nasional">
      <div class="file-info">Pastikan NISN valid dan sesuai dengan data Dapodik</div>

      <label class="required">NIK:</label>
      <input type="text" name="nik" required placeholder="Nomor Induk Kependudukan">
      <div class="file-info">Nomor yang tertera di Kartu Keluarga</div>

      <label class="required">Asal Sekolah SD:</label>
      <input type="text" name="sekolah" required placeholder="Nama sekolah asal">

      <label class="required">Alamat Desa/Kelurahan:</label>
      <input type="text" name="desa" required placeholder="Nama desa/kelurahan">

      <label class="required">Kecamatan:</label>
      <input type="text" name="kecamatan" required>

      <label class="required">Kabupaten/Kota:</label>
      <input type="text" name="kabupaten" required>

      <label class="required">Nama Ibu Kandung:</label>
      <input type="text" name="ibu" required placeholder="Nama lengkap ibu">

      <label class="required">Nama Ayah Kandung:</label>
      <input type="text" name="ayah" required placeholder="Nama lengkap ayah">

      <label class="required">Akta Kelahiran:</label>
      <input type="file" name="akta" accept=".pdf,.jpg,.jpeg,.png" required>
      <div class="file-info">Format: PDF/JPG/PNG (Maks. 2MB)</div>

      <label class="required">Kartu Keluarga:</label>
      <input type="file" name="kk" accept=".pdf,.jpg,.jpeg,.png" required>
      <div class="file-info">Halaman yang memuat data siswa</div>

      <label class="required">Surat Keterangan Lulus:</label>
      <input type="file" name="skl" accept=".pdf,.jpg,.jpeg,.png" required>
      <div class="file-info">Dari sekolah asal (bisa menyusul)</div>

      <div class="progress-container" id="progressContainer">
        <div class="progress">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div id="progressText" style="text-align: center; margin-top: 5px; font-size: 13px;">Mengunggah data...</div>
      </div>

      <div class="notif" id="notif"></div>

      <button type="submit" id="submitBtn">Kirim Pendaftaran</button>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('formulir');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const notif = document.getElementById('notif');
      const submitBtn = document.getElementById('submitBtn');

      // Ganti dengan URL deployment Anda
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz2s_84JcSNNzcRkFdIMEfQx-OuCEnv7LbWYfSnk1eUBDSQEITNNfBAH2uBVk9aY6PhyA/exec';

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        submitBtn.disabled = true;
        resetNotifications();
        showProgress(0, 'Memulai proses...');

        try {
          // Validasi form
          if (!validateForm()) {
            throw new Error('Harap lengkapi semua field yang wajib diisi');
          }

          // Persiapan data
          showProgress(10, 'Mempersiapkan data...');
          const formData = new FormData(form);
          const files = await processFiles(formData);
          
          // Membuat payload
          showProgress(30, 'Menyusun data...');
          const payload = {
            nama: formData.get('nama'),
            jk: formData.get('jk'),
            nisn: formData.get('nisn'),
            nik: formData.get('nik'),
            sekolah: formData.get('sekolah'),
            desa: formData.get('desa'),
            kecamatan: formData.get('kecamatan'),
            kabupaten: formData.get('kabupaten'),
            ibu: formData.get('ibu'),
            ayah: formData.get('ayah'),
            files: files
          };

          // Mengirim data
          showProgress(50, 'Mengirim data...');
          const response = await sendData(SCRIPT_URL, payload);
          
          // Handle response
          showProgress(90, 'Menyimpan data...');
          if (response.status === 'error') {
            throw new Error(response.error || 'Terjadi kesalahan pada server');
          }

          // Success
          showProgress(100, 'Selesai!');
          showNotification('✅ Pendaftaran berhasil dikirim! Nomor pendaftaran: ' + (response.data?.row || ''), 'success');
          form.reset();
          
        } catch (error) {
          console.error('Error:', error);
          showNotification(`❌ ${error.message}`, 'error');
          showProgress(0, '');
        } finally {
          submitBtn.disabled = false;
          setTimeout(() => {
            progressContainer.style.display = 'none';
          }, 3000);
        }
      });

      async function processFiles(formData) {
        const fileFields = ['akta', 'kk', 'skl'];
        const files = [];
        
        for (const field of fileFields) {
          const file = formData.get(field);
          if (file) {
            showProgress(10 + (30 * (files.length / fileFields.length)), `Memproses ${field}...`);
            const base64 = await toBase64(file);
            files.push({
              filename: file.name,
              content: base64.split(',')[1],
              mimeType: file.type
            });
          }
        }
        
        return files;
      }

      async function sendData(url, data) {
        try {
          const response = await fetch(url, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `Terjadi kesalahan (HTTP ${response.status})`);
          }

          return await response.json();
        } catch (error) {
          console.error('Network error:', error);
          throw new Error('Gagal terhubung ke server. Silakan coba lagi.');
        }
      }

      function toBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(new Error('Gagal membaca file'));
        });
      }

      function validateForm() {
        let isValid = true;
        const requiredFields = form.querySelectorAll('[required]');
        
        requiredFields.forEach(field => {
          if (!field.value.trim()) {
            isValid = false;
            field.style.borderColor = '#e74c3c';
          } else {
            field.style.borderColor = '#ddd';
          }
        });

        return isValid;
      }

      function showProgress(percent, message) {
        if (percent > 0) {
          progressContainer.style.display = 'block';
          progressBar.style.width = `${percent}%`;
          progressText.textContent = message;
        } else {
          progressContainer.style.display = 'none';
        }
      }

      function showNotification(message, type) {
        notif.textContent = message;
        notif.className = 'notif ' + type;
      }

      function resetNotifications() {
        notif.textContent = '';
        notif.className = 'notif';
        const errorFields = form.querySelectorAll('[style*="border-color"]');
        errorFields.forEach(field => field.style.borderColor = '');
      }
    });
  </script>
</body>
</html>
